image: jhe702/basebuild:base

stages:
#  - test
  - build
  - production


before_script:
  - curl -fsSL https://get.docker.com/ | sudo sh
  - usermod -aG docker $USER

#testcases:
#    stage: test
#    script:
#      - /root/.pyenv/versions/app/bin/pip install -r /srv/app/requirements/requirements.txt
#      - python manage.py test --noinput

job_build:
    stage: build

    script:
        - docker login registry.gitlab.com
        - docker build -t registry.gitlab.com/joohyon.lee/devocto .
        - docker push registry.gitlab.com/joohyon.lee/devocto

    only:
    - master


job_production:
    stage: production
    script:
        - docker login registry.gitlab.com
        - docker pull registry.gitlab.com/joohyon.lee/devocto
        - docker stop octocolumn || true && docker rm octocolumn || true
        - docker run --name=octocolumn -p 80:80 443:443 -itd registry.gitlab.com/joohyon.lee/devocto
    only:
    - master